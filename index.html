<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Shooter Elite</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #121212;
            color: white;
            overflow: hidden;
        }

        #app {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        /* Auth Screen */
        #auth-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #1a1a2e;
            z-index: 100;
            transition: opacity 0.3s;
        }

        #auth-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .auth-container {
            background-color: #16213e;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            width: 350px;
            max-width: 90%;
        }

        .auth-title {
            font-family: 'Press Start 2P', cursive;
            text-align: center;
            margin-bottom: 1.5rem;
            color: #e94560;
            font-size: 1.5rem;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .auth-input {
            padding: 0.8rem;
            border: none;
            border-radius: 5px;
            background-color: #0f3460;
            color: white;
            font-size: 1rem;
        }

        .auth-input::placeholder {
            color: #b8b8b8;
        }

        .auth-button {
            padding: 0.8rem;
            border: none;
            border-radius: 5px;
            background-color: #e94560;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        .auth-button:hover {
            background-color: #d13354;
        }

        .auth-toggle {
            margin-top: 1rem;
            text-align: center;
            color: #b8b8b8;
            cursor: pointer;
        }

        .auth-toggle span {
            color: #e94560;
            font-weight: bold;
        }

        .auth-error {
            color: #ff6b6b;
            margin-top: 1rem;
            text-align: center;
            font-size: 0.9rem;
        }

        /* Game Screen */
        #game-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
        }

        /* Game UI */
        .game-ui {
            display: flex;
            justify-content: space-between;
            padding: 1rem;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 10;
        }

        .player-info {
            display: flex;
            gap: 1rem;
        }

        .player-stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 0.5rem 1rem;
            border-radius: 20px;
        }

        .stat-icon {
            width: 20px;
            height: 20px;
        }

        .health-icon {
            color: #ff6b6b;
        }

        .coin-icon {
            color: #f9ca24;
        }

        .kills-icon {
            color: #ffffff;
        }

        .game-menu-button {
            background-color: #e94560;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .game-menu-button:hover {
            background-color: #d13354;
        }

        /* Game Canvas */
        .game-container {
            position: relative;
            flex-grow: 1;
            overflow: hidden;
        }

        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #0f3460;
        }

        /* Game Menu */
        #game-menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }

        .menu-container {
            background-color: #16213e;
            padding: 2rem;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .menu-title {
            font-family: 'Press Start 2P', cursive;
            text-align: center;
            margin-bottom: 1.5rem;
            color: #e94560;
            font-size: 1.5rem;
        }

        .menu-tabs {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .menu-tab {
            padding: 0.5rem 1rem;
            background-color: #0f3460;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .menu-tab.active {
            background-color: #e94560;
        }

        .menu-tab:hover {
            background-color: #1a3a6a;
        }

        .menu-tab.active:hover {
            background-color: #d13354;
        }

        .menu-content {
            display: none;
        }

        .menu-content.active {
            display: block;
        }

        /* Leaderboard */
        .leaderboard-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            background-color: rgba(15, 52, 96, 0.5);
            padding: 0.8rem;
            border-radius: 5px;
        }

        .leaderboard-rank {
            font-weight: bold;
            color: #f9ca24;
            width: 30px;
        }

        .leaderboard-name {
            flex-grow: 1;
        }

        .leaderboard-stats {
            display: flex;
            gap: 1rem;
        }

        /* Shop */
        .shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }

        .shop-item {
            background-color: #0f3460;
            border-radius: 5px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .shop-item:hover {
            transform: scale(1.05);
        }

        .shop-item-icon {
            width: 50px;
            height: 50px;
            background-color: #1a1a2e;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
        }

        .shop-item-name {
            font-weight: bold;
            text-align: center;
        }

        .shop-item-price {
            color: #f9ca24;
            font-weight: bold;
        }

        .shop-item-owned {
            color: #7fdbff;
            font-size: 0.8rem;
        }

        /* Friends */
        .friends-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .friend-item {
            display: flex;
            justify-content: space-between;
            background-color: rgba(15, 52, 96, 0.5);
            padding: 0.8rem;
            border-radius: 5px;
            align-items: center;
        }

        .friend-name {
            flex-grow: 1;
        }

        .friend-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 1rem;
        }

        .friend-status.online {
            background-color: #2ecc71;
        }

        .friend-status.offline {
            background-color: #e74c3c;
        }

        .friend-actions {
            display: flex;
            gap: 0.5rem;
        }

        .friend-action {
            background-color: #e94560;
            color: white;
            border: none;
            padding: 0.3rem 0.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .add-friend-form {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .add-friend-input {
            flex-grow: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 5px;
            background-color: #0f3460;
            color: white;
        }

        .add-friend-button {
            padding: 0.5rem 1rem;
            background-color: #e94560;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Clan */
        .clan-container {
            margin-bottom: 1.5rem;
        }

        .clan-info {
            background-color: rgba(15, 52, 96, 0.5);
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }

        .clan-members {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .clan-member {
            display: flex;
            justify-content: space-between;
            background-color: rgba(15, 52, 96, 0.3);
            padding: 0.5rem;
            border-radius: 5px;
        }

        .clan-form {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .clan-input {
            flex-grow: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 5px;
            background-color: #0f3460;
            color: white;
        }

        .clan-button {
            padding: 0.5rem 1rem;
            background-color: #e94560;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Game Modes */
        .game-modes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .game-mode {
            background-color: #0f3460;
            border-radius: 5px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .game-mode:hover {
            transform: scale(1.05);
        }

        .game-mode-icon {
            width: 50px;
            height: 50px;
            background-color: #1a1a2e;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
        }

        .game-mode-name {
            font-weight: bold;
            text-align: center;
        }

        .game-mode-desc {
            font-size: 0.8rem;
            text-align: center;
            color: #b8b8b8;
        }

        .join-game-form {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .join-game-input {
            flex-grow: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 5px;
            background-color: #0f3460;
            color: white;
        }

        .join-game-button {
            padding: 0.5rem 1rem;
            background-color: #e94560;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Chat */
        #chat-container {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 300px;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 10px 0 0 0;
            z-index: 10;
            display: flex;
            flex-direction: column;
            max-height: 40%;
        }

        #chat-header {
            padding: 0.5rem;
            background-color: #e94560;
            border-radius: 10px 0 0 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
        }

        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .chat-message {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 0.3rem 0.5rem;
            border-radius: 5px;
            font-size: 0.9rem;
            word-break: break-word;
        }

        .chat-message .sender {
            font-weight: bold;
            color: #e94560;
        }

        #chat-input-container {
            display: flex;
            padding: 0.5rem;
            gap: 0.5rem;
        }

        #chat-input {
            flex-grow: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        #chat-send {
            padding: 0.5rem;
            background-color: #e94560;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Respawn Screen */
        #respawn-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30;
        }

        .respawn-container {
            background-color: #16213e;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
        }

        .respawn-title {
            font-family: 'Press Start 2P', cursive;
            margin-bottom: 1rem;
            color: #e94560;
        }

        .respawn-timer {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .respawn-button {
            padding: 0.8rem 1.5rem;
            background-color: #e94560;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 5px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .toast.show {
            opacity: 1;
        }

        /* Loading Screen */
        #loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1a1a2e;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #e94560;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Weapon Selection */
        #weapon-selector {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 0.5rem;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 0.5rem;
            border-radius: 20px;
            z-index: 10;
        }

        .weapon-slot {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(15, 52, 96, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .weapon-slot:hover {
            transform: scale(1.1);
        }

        .weapon-slot.active {
            background-color: #e94560;
        }

        /* Crosshair */
        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            pointer-events: none;
            z-index: 5;
        }

        #crosshair::before, #crosshair::after {
            content: '';
            position: absolute;
            background-color: rgba(255, 255, 255, 0.8);
        }

        #crosshair::before {
            width: 2px;
            height: 20px;
            left: 9px;
            top: 0;
        }

        #crosshair::after {
            width: 20px;
            height: 2px;
            left: 0;
            top: 9px;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Loading Screen -->
        <div id="loading-screen">
            <div class="loading-spinner"></div>
        </div>

        <!-- Auth Screen -->
        <div id="auth-screen">
            <div class="auth-container">
                <h1 class="auth-title">FIREBASE SHOOTER ELITE</h1>
                <div id="login-form" class="auth-form">
                    <input type="email" id="login-email" class="auth-input" placeholder="Email">
                    <input type="password" id="login-password" class="auth-input" placeholder="Password">
                    <button id="login-button" class="auth-button">LOGIN</button>
                    <div class="auth-toggle">Don't have an account? <span id="show-signup">Sign up</span></div>
                    <div id="login-error" class="auth-error"></div>
                </div>
                <div id="signup-form" class="auth-form" style="display: none;">
                    <input type="text" id="signup-username" class="auth-input" placeholder="Username">
                    <input type="email" id="signup-email" class="auth-input" placeholder="Email">
                    <input type="password" id="signup-password" class="auth-input" placeholder="Password">
                    <button id="signup-button" class="auth-button">SIGN UP</button>
                    <div class="auth-toggle">Already have an account? <span id="show-login">Login</span></div>
                    <div id="signup-error" class="auth-error"></div>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen">
            <!-- Game UI -->
            <div class="game-ui">
                <div class="player-info">
                    <div class="player-stat">
                        <div class="stat-icon health-icon">❤️</div>
                        <span id="health-value">100</span>
                    </div>
                    <div class="player-stat">
                        <div class="stat-icon coin-icon">💰</div>
                        <span id="coin-value">0</span>
                    </div>
                    <div class="player-stat">
                        <div class="stat-icon kills-icon">🔫</div>
                        <span id="kills-value">0</span>
                    </div>
                </div>
                <button id="menu-button" class="game-menu-button">MENU</button>
            </div>

            <!-- Game Canvas -->
            <div class="game-container">
                <canvas id="game-canvas"></canvas>
                <div id="crosshair"></div>
            </div>

            <!-- Weapon Selector -->
            <div id="weapon-selector">
                <div class="weapon-slot active" data-weapon="pistol">🔫</div>
                <div class="weapon-slot" data-weapon="shotgun">💥</div>
                <div class="weapon-slot" data-weapon="rifle">🏹</div>
                <div class="weapon-slot" data-weapon="sniper">🎯</div>
                <div class="weapon-slot" data-weapon="minigun">🔥</div>
            </div>

            <!-- Game Menu -->
            <div id="game-menu">
                <div class="menu-container">
                    <h1 class="menu-title">GAME MENU</h1>
                    <div class="menu-tabs">
                        <button class="menu-tab active" data-tab="leaderboard">Leaderboard</button>
                        <button class="menu-tab" data-tab="shop">Shop</button>
                        <button class="menu-tab" data-tab="friends">Friends</button>
                        <button class="menu-tab" data-tab="clan">Clan</button>
                        <button class="menu-tab" data-tab="game-modes">Game Modes</button>
                    </div>
                    <div id="leaderboard-tab" class="menu-content active">
                        <h2>Top Players</h2>
                        <ul id="leaderboard-list" class="leaderboard-list"></ul>
                    </div>
                    <div id="shop-tab" class="menu-content">
                        <h2>Weapons Shop</h2>
                        <div id="shop-items" class="shop-items"></div>
                    </div>
                    <div id="friends-tab" class="menu-content">
                        <h2>Friends List</h2>
                        <ul id="friends-list" class="friends-list"></ul>
                        <div class="add-friend-form">
                            <input type="email" id="friend-email" class="add-friend-input" placeholder="Friend's email">
                            <button id="add-friend-button" class="add-friend-button">Add</button>
                        </div>
                    </div>
                    <div id="clan-tab" class="menu-content">
                        <div class="clan-container">
                            <h2>Clan</h2>
                            <div id="clan-info" class="clan-info" style="display: none;">
                                <h3 id="clan-name"></h3>
                                <p id="clan-members-count"></p>
                                <ul id="clan-members-list" class="clan-members"></ul>
                                <button id="leave-clan-button" class="clan-button">Leave Clan</button>
                            </div>
                            <div id="no-clan-message">
                                <p>You're not in a clan. Join or create one below.</p>
                                <div class="clan-form">
                                    <input type="text" id="join-clan-input" class="clan-input" placeholder="Clan code">
                                    <button id="join-clan-button" class="clan-button">Join</button>
                                </div>
                                <div class="clan-form" style="margin-top: 0.5rem;">
                                    <input type="text" id="create-clan-input" class="clan-input" placeholder="Clan name">
                                    <button id="create-clan-button" class="clan-button">Create</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="game-modes-tab" class="menu-content">
                        <h2>Game Modes</h2>
                        <div class="game-modes">
                            <div class="game-mode" data-mode="public">
                                <div class="game-mode-icon">🌐</div>
                                <div class="game-mode-name">Public Match</div>
                                <div class="game-mode-desc">Join a random public game</div>
                            </div>
                            <div class="game-mode" data-mode="private">
                                <div class="game-mode-icon">🔒</div>
                                <div class="game-mode-name">Private Match</div>
                                <div class="game-mode-desc">Create a private game</div>
                            </div>
                            <div class="game-mode" data-mode="join">
                                <div class="game-mode-icon">🎮</div>
                                <div class="game-mode-name">Join Game</div>
                                <div class="game-mode-desc">Join with a game code</div>
                            </div>
                        </div>
                        <div id="join-game-form" class="join-game-form" style="display: none; margin-top: 1rem;">
                            <input type="text" id="game-code-input" class="join-game-input" placeholder="Enter game code">
                            <button id="join-game-button" class="join-game-button">Join</button>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 1.5rem;">
                        <button id="logout-button" class="game-menu-button">LOGOUT</button>
                    </div>
                </div>
            </div>

            <!-- Chat -->
            <div id="chat-container">
                <div id="chat-header">
                    <span>Chat</span>
                    <span id="chat-toggle">−</span>
                </div>
                <div id="chat-messages"></div>
                <div id="chat-input-container">
                    <input type="text" id="chat-input" placeholder="Type a message...">
                    <button id="chat-send">Send</button>
                </div>
            </div>

            <!-- Respawn Screen -->
            <div id="respawn-screen">
                <div class="respawn-container">
                    <h1 class="respawn-title">YOU DIED</h1>
                    <div class="respawn-timer" id="respawn-timer">Respawning in 3...</div>
                    <button id="respawn-button" class="respawn-button">RESPAWN NOW</button>
                </div>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div id="toast" class="toast"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDpeT73fOAYADnV5CPSgINSlWVyXZE9cjg",
            authDomain: "code-clash-royale.firebaseapp.com",
            databaseURL: "https://code-clash-royale-default-rtdb.firebaseio.com",
            projectId: "code-clash-royale",
            storageBucket: "code-clash-royale.firebasestorage.app",
            messagingSenderId: "830102918327",
            appId: "1:830102918327:web:719af83564999094e2a932",
            measurementId: "G-14D9SQ9EZR"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Game state
        const gameState = {
            player: null,
            players: {},
            bullets: {},
            loot: {},
            healthPacks: {},
            currentWeapon: 'pistol',
            weapons: {
                pistol: { damage: 15, fireRate: 400, range: 400, price: 0, owned: true, bulletSpeed: 15, icon: '🔫' },
                shotgun: { damage: 40, fireRate: 1000, range: 250, price: 500, owned: false, bulletSpeed: 12, spread: 0.2, bullets: 5, icon: '💥' },
                rifle: { damage: 25, fireRate: 150, range: 500, price: 1000, owned: false, bulletSpeed: 20, icon: '🏹' },
                sniper: { damage: 80, fireRate: 1200, range: 800, price: 2000, owned: false, bulletSpeed: 30, icon: '🎯' },
                minigun: { damage: 12, fireRate: 50, range: 450, price: 3000, owned: false, bulletSpeed: 18, icon: '🔥' },
                revolver: { damage: 35, fireRate: 600, range: 450, price: 750, owned: false, bulletSpeed: 16, icon: '🔫' },
                smg: { damage: 18, fireRate: 100, range: 350, price: 800, owned: false, bulletSpeed: 17, icon: '🔫' },
                assault: { damage: 22, fireRate: 120, range: 550, price: 1500, owned: false, bulletSpeed: 22, icon: '🔫' },
                grenade: { damage: 60, fireRate: 2000, range: 300, price: 1200, owned: false, bulletSpeed: 8, icon: '💣' },
                flamethrower: { damage: 10, fireRate: 30, range: 200, price: 2500, owned: false, bulletSpeed: 10, icon: '🔥' },
                railgun: { damage: 100, fireRate: 2500, range: 900, price: 4000, owned: false, bulletSpeed: 40, icon: '⚡' }
            },
            lastShot: 0,
            coins: 0,
            health: 100,
            kills: 0,
            deaths: 0,
            isAlive: true,
            respawnTime: 0,
            friends: {},
            friendRequests: {},
            clan: null,
            clanMembers: {},
            chatMessages: [],
            maps: [
                {
                    name: "Desert",
                    width: 2500,
                    height: 2500,
                    obstacles: [
                        { x: 300, y: 300, width: 200, height: 200 },
                        { x: 700, y: 500, width: 150, height: 300 },
                        { x: 1000, y: 200, width: 100, height: 100 },
                        { x: 1200, y: 600, width: 250, height: 150 },
                        { x: 500, y: 800, width: 200, height: 200 },
                        { x: 900, y: 900, width: 300, height: 100 },
                        { x: 1500, y: 400, width: 200, height: 200 },
                        { x: 1800, y: 700, width: 150, height: 150 },
                        { x: 200, y: 1200, width: 300, height: 200 },
                        { x: 600, y: 1500, width: 250, height: 150 }
                    ],
                    color: '#d2b48c'
                },
                {
                    name: "City",
                    width: 3000,
                    height: 3000,
                    obstacles: [
                        { x: 200, y: 200, width: 150, height: 150 },
                        { x: 500, y: 200, width: 150, height: 150 },
                        { x: 800, y: 200, width: 150, height: 150 },
                        { x: 1100, y: 200, width: 150, height: 150 },
                        { x: 200, y: 500, width: 150, height: 150 },
                        { x: 500, y: 500, width: 300, height: 150 },
                        { x: 900, y: 500, width: 150, height: 150 },
                        { x: 200, y: 800, width: 150, height: 150 },
                        { x: 500, y: 800, width: 150, height: 300 },
                        { x: 800, y: 800, width: 150, height: 150 },
                        { x: 1100, y: 800, width: 150, height: 150 },
                        { x: 1400, y: 800, width: 150, height: 150 },
                        { x: 1700, y: 800, width: 150, height: 150 },
                        { x: 2000, y: 800, width: 150, height: 150 },
                        { x: 2300, y: 800, width: 150, height: 150 },
                        { x: 200, y: 1100, width: 150, height: 150 },
                        { x: 500, y: 1100, width: 150, height: 150 },
                        { x: 800, y: 1100, width: 150, height: 150 },
                        { x: 1100, y: 1100, width: 150, height: 150 },
                        { x: 1400, y: 1100, width: 150, height: 150 },
                        { x: 1700, y: 1100, width: 150, height: 150 },
                        { x: 2000, y: 1100, width: 150, height: 150 },
                        { x: 2300, y: 1100, width: 150, height: 150 },
                        { x: 200, y: 1400, width: 150, height: 150 },
                        { x: 500, y: 1400, width: 150, height: 150 },
                        { x: 800, y: 1400, width: 150, height: 150 },
                        { x: 1100, y: 1400, width: 150, height: 150 },
                        { x: 1400, y: 1400, width: 150, height: 150 },
                        { x: 1700, y: 1400, width: 150, height: 150 },
                        { x: 2000, y: 1400, width: 150, height: 150 },
                        { x: 2300, y: 1400, width: 150, height: 150 },
                        { x: 200, y: 1700, width: 150, height: 150 },
                        { x: 500, y: 1700, width: 150, height: 150 },
                        { x: 800, y: 1700, width: 150, height: 150 },
                        { x: 1100, y: 1700, width: 150, height: 150 },
                        { x: 1400, y: 1700, width: 150, height: 150 },
                        { x: 1700, y: 1700, width: 150, height: 150 },
                        { x: 2000, y: 1700, width: 150, height: 150 },
                        { x: 2300, y: 1700, width: 150, height: 150 },
                        { x: 200, y: 2000, width: 150, height: 150 },
                        { x: 500, y: 2000, width: 150, height: 150 },
                        { x: 800, y: 2000, width: 150, height: 150 },
                        { x: 1100, y: 2000, width: 150, height: 150 },
                        { x: 1400, y: 2000, width: 150, height: 150 },
                        { x: 1700, y: 2000, width: 150, height: 150 },
                        { x: 2000, y: 2000, width: 150, height: 150 },
                        { x: 2300, y: 2000, width: 150, height: 150 },
                        { x: 200, y: 2300, width: 150, height: 150 },
                        { x: 500, y: 2300, width: 150, height: 150 },
                        { x: 800, y: 2300, width: 150, height: 150 },
                        { x: 1100, y: 2300, width: 150, height: 150 },
                        { x: 1400, y: 2300, width: 150, height: 150 },
                        { x: 1700, y: 2300, width: 150, height: 150 },
                        { x: 2000, y: 2300, width: 150, height: 150 },
                        { x: 2300, y: 2300, width: 150, height: 150 }
                    ],
                    color: '#7f8c8d'
                },
                {
                    name: "Forest",
                    width: 3500,
                    height: 3500,
                    obstacles: [
                        { x: 300, y: 300, width: 100, height: 100 },
                        { x: 500, y: 300, width: 100, height: 100 },
                        { x: 700, y: 300, width: 100, height: 100 },
                        { x: 900, y: 300, width: 100, height: 100 },
                        { x: 1100, y: 300, width: 100, height: 100 },
                        { x: 1300, y: 300, width: 100, height: 100 },
                        { x: 1500, y: 300, width: 100, height: 100 },
                        { x: 1700, y: 300, width: 100, height: 100 },
                        { x: 1900, y: 300, width: 100, height: 100 },
                        { x: 2100, y: 300, width: 100, height: 100 },
                        { x: 2300, y: 300, width: 100, height: 100 },
                        { x: 2500, y: 300, width: 100, height: 100 },
                        { x: 2700, y: 300, width: 100, height: 100 },
                        { x: 2900, y: 300, width: 100, height: 100 },
                        { x: 3100, y: 300, width: 100, height: 100 },
                        { x: 3300, y: 300, width: 100, height: 100 },
                        { x: 300, y: 500, width: 100, height: 100 },
                        { x: 500, y: 500, width: 100, height: 100 },
                        { x: 700, y: 500, width: 100, height: 100 },
                        { x: 900, y: 500, width: 100, height: 100 },
                        { x: 1100, y: 500, width: 100, height: 100 },
                        { x: 1300, y: 500, width: 100, height: 100 },
                        { x: 1500, y: 500, width: 100, height: 100 },
                        { x: 1700, y: 500, width: 100, height: 100 },
                        { x: 1900, y: 500, width: 100, height: 100 },
                        { x: 2100, y: 500, width: 100, height: 100 },
                        { x: 2300, y: 500, width: 100, height: 100 },
                        { x: 2500, y: 500, width: 100, height: 100 },
                        { x: 2700, y: 500, width: 100, height: 100 },
                        { x: 2900, y: 500, width: 100, height: 100 },
                        { x: 3100, y: 500, width: 100, height: 100 },
                        { x: 3300, y: 500, width: 100, height: 100 },
                        { x: 300, y: 700, width: 100, height: 100 },
                        { x: 500, y: 700, width: 100, height: 100 },
                        { x: 700, y: 700, width: 100, height: 100 },
                        { x: 900, y: 700, width: 100, height: 100 },
                        { x: 1100, y: 700, width: 100, height: 100 },
                        { x: 1300, y: 700, width: 100, height: 100 },
                        { x: 1500, y: 700, width: 100, height: 100 },
                        { x: 1700, y: 700, width: 100, height: 100 },
                        { x: 1900, y: 700, width: 100, height: 100 },
                        { x: 2100, y: 700, width: 100, height: 100 },
                        { x: 2300, y: 700, width: 100, height: 100 },
                        { x: 2500, y: 700, width: 100, height: 100 },
                        { x: 2700, y: 700, width: 100, height: 100 },
                        { x: 2900, y: 700, width: 100, height: 100 },
                        { x: 3100, y: 700, width: 100, height: 100 },
                        { x: 3300, y: 700, width: 100, height: 100 },
                        { x: 300, y: 900, width: 100, height: 100 },
                        { x: 500, y: 900, width: 100, height: 100 },
                        { x: 700, y: 900, width: 100, height: 100 },
                        { x: 900, y: 900, width: 100, height: 100 },
                        { x: 1100, y: 900, width: 100, height: 100 },
                        { x: 1300, y: 900, width: 100, height: 100 },
                        { x: 1500, y: 900, width: 100, height: 100 },
                        { x: 1700, y: 900, width: 100, height: 100 },
                        { x: 1900, y: 900, width: 100, height: 100 },
                        { x: 2100, y: 900, width: 100, height: 100 },
                        { x: 2300, y: 900, width: 100, height: 100 },
                        { x: 2500, y: 900, width: 100, height: 100 },
                        { x: 2700, y: 900, width: 100, height: 100 },
                        { x: 2900, y: 900, width: 100, height: 100 },
                        { x: 3100, y: 900, width: 100, height: 100 },
                        { x: 3300, y: 900, width: 100, height: 100 },
                        { x: 300, y: 1100, width: 100, height: 100 },
                        { x: 500, y: 1100, width: 100, height: 100 },
                        { x: 700, y: 1100, width: 100, height: 100 },
                        { x: 900, y: 1100, width: 100, height: 100 },
                        { x: 1100, y: 1100, width: 100, height: 100 },
                        { x: 1300, y: 1100, width: 100, height: 100 },
                        { x: 1500, y: 1100, width: 100, height: 100 },
                        { x: 1700, y: 1100, width: 100, height: 100 },
                        { x: 1900, y: 1100, width: 100, height: 100 },
                        { x: 2100, y: 1100, width: 100, height: 100 },
                        { x: 2300, y: 1100, width: 100, height: 100 },
                        { x: 2500, y: 1100, width: 100, height: 100 },
                        { x: 2700, y: 1100, width: 100, height: 100 },
                        { x: 2900, y: 1100, width: 100, height: 100 },
                        { x: 3100, y: 1100, width: 100, height: 100 },
                        { x: 3300, y: 1100, width: 100, height: 100 },
                        { x: 300, y: 1300, width: 100, height: 100 },
                        { x: 500, y: 1300, width: 100, height: 100 },
                        { x: 700, y: 1300, width: 100, height: 100 },
                        { x: 900, y: 1300, width: 100, height: 100 },
                        { x: 1100, y: 1300, width: 100, height: 100 },
                        { x: 1300, y: 1300, width: 100, height: 100 },
                        { x: 1500, y: 1300, width: 100, height: 100 },
                        { x: 1700, y: 1300, width: 100, height: 100 },
                        { x: 1900, y: 1300, width: 100, height: 100 },
                        { x: 2100, y: 1300, width: 100, height: 100 },
                        { x: 2300, y: 1300, width: 100, height: 100 },
                        { x: 2500, y: 1300, width: 100, height: 100 },
                        { x: 2700, y: 1300, width: 100, height: 100 },
                        { x: 2900, y: 1300, width: 100, height: 100 },
                        { x: 3100, y: 1300, width: 100, height: 100 },
                        { x: 3300, y: 1300, width: 100, height: 100 },
                        { x: 300, y: 1500, width: 100, height: 100 },
                        { x: 500, y: 1500, width: 100, height: 100 },
                        { x: 700, y: 1500, width: 100, height: 100 },
                        { x: 900, y: 1500, width: 100, height: 100 },
                        { x: 1100, y: 1500, width: 100, height: 100 },
                        { x: 1300, y: 1500, width: 100, height: 100 },
                        { x: 1500, y: 1500, width: 100, height: 100 },
                        { x: 1700, y: 1500, width: 100, height: 100 },
                        { x: 1900, y: 1500, width: 100, height: 100 },
                        { x: 2100, y: 1500, width: 100, height: 100 },
                        { x: 2300, y: 1500, width: 100, height: 100 },
                        { x: 2500, y: 1500, width: 100, height: 100 },
                        { x: 2700, y: 1500, width: 100, height: 100 },
                        { x: 2900, y: 1500, width: 100, height: 100 },
                        { x: 3100, y: 1500, width: 100, height: 100 },
                        { x: 3300, y: 1500, width: 100, height: 100 },
                        { x: 300, y: 1700, width: 100, height: 100 },
                        { x: 500, y: 1700, width: 100, height: 100 },
                        { x: 700, y: 1700, width: 100, height: 100 },
                        { x: 900, y: 1700, width: 100, height: 100 },
                        { x: 1100, y: 1700, width: 100, height: 100 },
                        { x: 1300, y: 1700, width: 100, height: 100 },
                        { x: 1500, y: 1700, width: 100, height: 100 },
                        { x: 1700, y: 1700, width: 100, height: 100 },
                        { x: 1900, y: 1700, width: 100, height: 100 },
                        { x: 2100, y: 1700, width: 100, height: 100 },
                        { x: 2300, y: 1700, width: 100, height: 100 },
                        { x: 2500, y: 1700, width: 100, height: 100 },
                        { x: 2700, y: 1700, width: 100, height: 100 },
                        { x: 2900, y: 1700, width: 100, height: 100 },
                        { x: 3100, y: 1700, width: 100, height: 100 },
                        { x: 3300, y: 1700, width: 100, height: 100 },
                        { x: 300, y: 1900, width: 100, height: 100 },
                        { x: 500, y: 1900, width: 100, height: 100 },
                        { x: 700, y: 1900, width: 100, height: 100 },
                        { x: 900, y: 1900, width: 100, height: 100 },
                        { x: 1100, y: 1900, width: 100, height: 100 },
                        { x: 1300, y: 1900, width: 100, height: 100 },
                        { x: 1500, y: 1900, width: 100, height: 100 },
                        { x: 1700, y: 1900, width: 100, height: 100 },
                        { x: 1900, y: 1900, width: 100, height: 100 },
                        { x: 2100, y: 1900, width: 100, height: 100 },
                        { x: 2300, y: 1900, width: 100, height: 100 },
                        { x: 2500, y: 1900, width: 100, height: 100 },
                        { x: 2700, y: 1900, width: 100, height: 100 },
                        { x: 2900, y: 1900, width: 100, height: 100 },
                        { x: 3100, y: 1900, width: 100, height: 100 },
                        { x: 3300, y: 1900, width: 100, height: 100 },
                        { x: 300, y: 2100, width: 100, height: 100 },
                        { x: 500, y: 2100, width: 100, height: 100 },
                        { x: 700, y: 2100, width: 100, height: 100 },
                        { x: 900, y: 2100, width: 100, height: 100 },
                        { x: 1100, y: 2100, width: 100, height: 100 },
                        { x: 1300, y: 2100, width: 100, height: 100 },
                        { x: 1500, y: 2100, width: 100, height: 100 },
                        { x: 1700, y: 2100, width: 100, height: 100 },
                        { x: 1900, y: 2100, width: 100, height: 100 },
                        { x: 2100, y: 2100, width: 100, height: 100 },
                        { x: 2300, y: 2100, width: 100, height: 100 },
                        { x: 2500, y: 2100, width: 100, height: 100 },
                        { x: 2700, y: 2100, width: 100, height: 100 },
                        { x: 2900, y: 2100, width: 100, height: 100 },
                        { x: 3100, y: 2100, width: 100, height: 100 },
                        { x: 3300, y: 2100, width: 100, height: 100 },
                        { x: 300, y: 2300, width: 100, height: 100 },
                        { x: 500, y: 2300, width: 100, height: 100 },
                        { x: 700, y: 2300, width: 100, height: 100 },
                        { x: 900, y: 2300, width: 100, height: 100 },
                        { x: 1100, y: 2300, width: 100, height: 100 },
                        { x: 1300, y: 2300, width: 100, height: 100 },
                        { x: 1500, y: 2300, width: 100, height: 100 },
                        { x: 1700, y: 2300, width: 100, height: 100 },
                        { x: 1900, y: 2300, width: 100, height: 100 },
                        { x: 2100, y: 2300, width: 100, height: 100 },
                        { x: 2300, y: 2300, width: 100, height: 100 },
                        { x: 2500, y: 2300, width: 100, height: 100 },
                        { x: 2700, y: 2300, width: 100, height: 100 },
                        { x: 2900, y: 2300, width: 100, height: 100 },
                        { x: 3100, y: 2300, width: 100, height: 100 },
                        { x: 3300, y: 2300, width: 100, height: 100 },
                        { x: 300, y: 2500, width: 100, height: 100 },
                        { x: 500, y: 2500, width: 100, height: 100 },
                        { x: 700, y: 2500, width: 100, height: 100 },
                        { x: 900, y: 2500, width: 100, height: 100 },
                        { x: 1100, y: 2500, width: 100, height: 100 },
                        { x: 1300, y: 2500, width: 100, height: 100 },
                        { x: 1500, y: 2500, width: 100, height: 100 },
                        { x: 1700, y: 2500, width: 100, height: 100 },
                        { x: 1900, y: 2500, width: 100, height: 100 },
                        { x: 2100, y: 2500, width: 100, height: 100 },
                        { x: 2300, y: 2500, width: 100, height: 100 },
                        { x: 2500, y: 2500, width: 100, height: 100 },
                        { x: 2700, y: 2500, width: 100, height: 100 },
                        { x: 2900, y: 2500, width: 100, height: 100 },
                        { x: 3100, y: 2500, width: 100, height: 100 },
                        { x: 3300, y: 2500, width: 100, height: 100 },
                        { x: 300, y: 2700, width: 100, height: 100 },
                        { x: 500, y: 2700, width: 100, height: 100 },
                        { x: 700, y: 2700, width: 100, height: 100 },
                        { x: 900, y: 2700, width: 100, height: 100 },
                        { x: 1100, y: 2700, width: 100, height: 100 },
                        { x: 1300, y: 2700, width: 100, height: 100 },
                        { x: 1500, y: 2700, width: 100, height: 100 },
                        { x: 1700, y: 2700, width: 100, height: 100 },
                        { x: 1900, y: 2700, width: 100, height: 100 },
                        { x: 2100, y: 2700, width: 100, height: 100 },
                        { x: 2300, y: 2700, width: 100, height: 100 },
                        { x: 2500, y: 2700, width: 100, height: 100 },
                        { x: 2700, y: 2700, width: 100, height: 100 },
                        { x: 2900, y: 2700, width: 100, height: 100 },
                        { x: 3100, y: 2700, width: 100, height: 100 },
                        { x: 3300, y: 2700, width: 100, height: 100 },
                        { x: 300, y: 2900, width: 100, height: 100 },
                        { x: 500, y: 2900, width: 100, height: 100 },
                        { x: 700, y: 2900, width: 100, height: 100 },
                        { x: 900, y: 2900, width: 100, height: 100 },
                        { x: 1100, y: 2900, width: 100, height: 100 },
                        { x: 1300, y: 2900, width: 100, height: 100 },
                        { x: 1500, y: 2900, width: 100, height: 100 },
                        { x: 1700, y: 2900, width: 100, height: 100 },
                        { x: 1900, y: 2900, width: 100, height: 100 },
                        { x: 2100, y: 2900, width: 100, height: 100 },
                        { x: 2300, y: 2900, width: 100, height: 100 },
                        { x: 2500, y: 2900, width: 100, height: 100 },
                        { x: 2700, y: 2900, width: 100, height: 100 },
                        { x: 2900, y: 2900, width: 100, height: 100 },
                        { x: 3100, y: 2900, width: 100, height: 100 },
                        { x: 3300, y: 2900, width: 100, height: 100 },
                        { x: 300, y: 3100, width: 100, height: 100 },
                        { x: 500, y: 3100, width: 100, height: 100 },
                        { x: 700, y: 3100, width: 100, height: 100 },
                        { x: 900, y: 3100, width: 100, height: 100 },
                        { x: 1100, y: 3100, width: 100, height: 100 },
                        { x: 1300, y: 3100, width: 100, height: 100 },
                        { x: 1500, y: 3100, width: 100, height: 100 },
                        { x: 1700, y: 3100, width: 100, height: 100 },
                        { x: 1900, y: 3100, width: 100, height: 100 },
                        { x: 2100, y: 3100, width: 100, height: 100 },
                        { x: 2300, y: 3100, width: 100, height: 100 },
                        { x: 2500, y: 3100, width: 100, height: 100 },
                        { x: 2700, y: 3100, width: 100, height: 100 },
                        { x: 2900, y: 3100, width: 100, height: 100 },
                        { x: 3100, y: 3100, width: 100, height: 100 },
                        { x: 3300, y: 3100, width: 100, height: 100 }
                    ],
                    color: '#2e8b57'
                }
            ],
            currentMap: 0,
            keys: {
                w: false,
                a: false,
                s: false,
                d: false,
                shift: false
            },
            mouse: {
                x: 0,
                y: 0,
                angle: 0
            },
            isShooting: false,
            gameLoopInterval: null,
            playerRef: null,
            playersRef: null,
            bulletsRef: null,
            lootRef: null,
            healthPacksRef: null,
            leaderboardRef: null,
            friendsRef: null,
            friendRequestsRef: null,
            clanRef: null,
            clanMembersRef: null,
            chatRef: null,
            gameMode: 'public',
            gameCode: null
        };

        // DOM elements
        const elements = {
            loadingScreen: document.getElementById('loading-screen'),
            authScreen: document.getElementById('auth-screen'),
            loginForm: document.getElementById('login-form'),
            signupForm: document.getElementById('signup-form'),
            loginEmail: document.getElementById('login-email'),
            loginPassword: document.getElementById('login-password'),
            loginButton: document.getElementById('login-button'),
            loginError: document.getElementById('login-error'),
            signupUsername: document.getElementById('signup-username'),
            signupEmail: document.getElementById('signup-email'),
            signupPassword: document.getElementById('signup-password'),
            signupButton: document.getElementById('signup-button'),
            signupError: document.getElementById('signup-error'),
            showSignup: document.getElementById('show-signup'),
            showLogin: document.getElementById('show-login'),
            gameScreen: document.getElementById('game-screen'),
            gameCanvas: document.getElementById('game-canvas'),
            healthValue: document.getElementById('health-value'),
            coinValue: document.getElementById('coin-value'),
            killsValue: document.getElementById('kills-value'),
            menuButton: document.getElementById('menu-button'),
            gameMenu: document.getElementById('game-menu'),
            menuTabs: document.querySelectorAll('.menu-tab'),
            menuContents: document.querySelectorAll('.menu-content'),
            leaderboardList: document.getElementById('leaderboard-list'),
            shopItems: document.getElementById('shop-items'),
            friendsList: document.getElementById('friends-list'),
            friendEmail: document.getElementById('friend-email'),
            addFriendButton: document.getElementById('add-friend-button'),
            clanInfo: document.getElementById('clan-info'),
            clanName: document.getElementById('clan-name'),
            clanMembersCount: document.getElementById('clan-members-count'),
            clanMembersList: document.getElementById('clan-members-list'),
            joinClanInput: document.getElementById('join-clan-input'),
            joinClanButton: document.getElementById('join-clan-button'),
            createClanInput: document.getElementById('create-clan-input'),
            createClanButton: document.getElementById('create-clan-button'),
            leaveClanButton: document.getElementById('leave-clan-button'),
            noClanMessage: document.getElementById('no-clan-message'),
            logoutButton: document.getElementById('logout-button'),
            chatContainer: document.getElementById('chat-container'),
            chatHeader: document.getElementById('chat-header'),
            chatToggle: document.getElementById('chat-toggle'),
            chatMessages: document.getElementById('chat-messages'),
            chatInput: document.getElementById('chat-input'),
            chatSend: document.getElementById('chat-send'),
            respawnScreen: document.getElementById('respawn-screen'),
            respawnTimer: document.getElementById('respawn-timer'),
            respawnButton: document.getElementById('respawn-button'),
            weaponSelector: document.getElementById('weapon-selector'),
            gameModes: document.querySelectorAll('.game-mode'),
            joinGameForm: document.getElementById('join-game-form'),
            gameCodeInput: document.getElementById('game-code-input'),
            joinGameButton: document.getElementById('join-game-button'),
            toast: document.getElementById('toast')
        };

        // Canvas context
        const ctx = elements.gameCanvas.getContext('2d');

        // Initialize canvas size
        function initCanvas() {
            elements.gameCanvas.width = window.innerWidth;
            elements.gameCanvas.height = window.innerHeight;
        }

        // Event listeners
        function setupEventListeners() {
            // Auth screen
            elements.showSignup.addEventListener('click', () => {
                elements.loginForm.style.display = 'none';
                elements.signupForm.style.display = 'flex';
            });
            
            elements.showLogin.addEventListener('click', () => {
                elements.signupForm.style.display = 'none';
                elements.loginForm.style.display = 'flex';
            });
            
            elements.loginButton.addEventListener('click', login);
            elements.signupButton.addEventListener('click', signup);
            
            // Game screen
            window.addEventListener('resize', initCanvas);
            
            // Keyboard controls
            window.addEventListener('keydown', (e) => {
                if (e.key.toLowerCase() === 'w') gameState.keys.w = true;
                if (e.key.toLowerCase() === 'a') gameState.keys.a = true;
                if (e.key.toLowerCase() === 's') gameState.keys.s = true;
                if (e.key.toLowerCase() === 'd') gameState.keys.d = true;
                if (e.key === 'Shift') gameState.keys.shift = true;
                
                // Number keys for weapon switching
                if (e.key === '1') switchWeapon('pistol');
                if (e.key === '2') switchWeapon('shotgun');
                if (e.key === '3') switchWeapon('rifle');
                if (e.key === '4') switchWeapon('sniper');
                if (e.key === '5') switchWeapon('minigun');
            });
            
            window.addEventListener('keyup', (e) => {
                if (e.key.toLowerCase() === 'w') gameState.keys.w = false;
                if (e.key.toLowerCase() === 'a') gameState.keys.a = false;
                if (e.key.toLowerCase() === 's') gameState.keys.s = false;
                if (e.key.toLowerCase() === 'd') gameState.keys.d = false;
                if (e.key === 'Shift') gameState.keys.shift = false;
            });
            
            // Mouse controls
            elements.gameCanvas.addEventListener('mousemove', (e) => {
                const rect = elements.gameCanvas.getBoundingClientRect();
                gameState.mouse.x = e.clientX - rect.left;
                gameState.mouse.y = e.clientY - rect.top;
                
                if (gameState.player) {
                    const dx = gameState.mouse.x - elements.gameCanvas.width / 2;
                    const dy = gameState.mouse.y - elements.gameCanvas.height / 2;
                    gameState.mouse.angle = Math.atan2(dy, dx);
                }
            });
            
            elements.gameCanvas.addEventListener('mousedown', (e) => {
                if (e.button === 0) { // Left click
                    gameState.isShooting = true;
                }
            });
            
            elements.gameCanvas.addEventListener('mouseup', (e) => {
                if (e.button === 0) { // Left click
                    gameState.isShooting = false;
                }
            });
            
            // Game menu
            elements.menuButton.addEventListener('click', toggleMenu);
            
            elements.menuTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            elements.logoutButton.addEventListener('click', logout);
            
            // Chat
            elements.chatToggle.addEventListener('click', toggleChat);
            elements.chatSend.addEventListener('click', sendChatMessage);
            elements.chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChatMessage();
            });
            
            // Respawn
            elements.respawnButton.addEventListener('click', respawnPlayer);
            
            // Shop
            elements.shopItems.addEventListener('click', (e) => {
                if (e.target.classList.contains('shop-item')) {
                    const weaponId = e.target.getAttribute('data-weapon');
                    buyWeapon(weaponId);
                }
            });
            
            // Friends
            elements.addFriendButton.addEventListener('click', sendFriendRequest);
            
            // Clan
            elements.joinClanButton.addEventListener('click', joinClan);
            elements.createClanButton.addEventListener('click', createClan);
            elements.leaveClanButton.addEventListener('click', leaveClan);
            
            // Weapon selector
            elements.weaponSelector.addEventListener('click', (e) => {
                if (e.target.classList.contains('weapon-slot')) {
                    const weaponId = e.target.getAttribute('data-weapon');
                    switchWeapon(weaponId);
                }
            });
            
            // Game modes
            elements.gameModes.forEach(mode => {
                mode.addEventListener('click', () => {
                    const modeId = mode.getAttribute('data-mode');
                    selectGameMode(modeId);
                });
            });
            
            elements.joinGameButton.addEventListener('click', joinPrivateGame);
        }

        // Auth functions
        function login() {
            const email = elements.loginEmail.value;
            const password = elements.loginPassword.value;
            
            if (!email || !password) {
                showError(elements.loginError, 'Please fill in all fields');
                return;
            }
            
            showLoading();
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Signed in
                    const user = userCredential.user;
                    loadPlayerData(user.uid);
                })
                .catch((error) => {
                    hideLoading();
                    showError(elements.loginError, error.message);
                });
        }
        
        function signup() {
            const username = elements.signupUsername.value;
            const email = elements.signupEmail.value;
            const password = elements.signupPassword.value;
            
            if (!username || !email || !password) {
                showError(elements.signupError, 'Please fill in all fields');
                return;
            }
            
            if (username.length < 3 || username.length > 15) {
                showError(elements.signupError, 'Username must be 3-15 characters');
                return;
            }
            
            showLoading();
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Signed up
                    const user = userCredential.user;
                    
                    // Create player data
                    const playerData = {
                        username: username,
                        email: email,
                        health: 100,
                        coins: 0,
                        kills: 0,
                        deaths: 0,
                        x: Math.random() * gameState.maps[0].width,
                        y: Math.random() * gameState.maps[0].height,
                        lastUpdated: Date.now(),
                        weapons: {
                            pistol: true
                        },
                        currentWeapon: 'pistol',
                        clan: null
                    };
                    
                    // Save player data
                    return database.ref('players/' + user.uid).set(playerData);
                })
                .then(() => {
                    const user = auth.currentUser;
                    loadPlayerData(user.uid);
                })
                .catch((error) => {
                    hideLoading();
                    showError(elements.signupError, error.message);
                });
        }
        
        function logout() {
            auth.signOut().then(() => {
                // Clear game state
                clearGameState();
                
                // Show auth screen
                elements.gameScreen.style.display = 'none';
                elements.authScreen.classList.remove('hidden');
                
                // Reset forms
                elements.loginForm.style.display = 'flex';
                elements.signupForm.style.display = 'none';
                elements.loginEmail.value = '';
                elements.loginPassword.value = '';
                elements.signupUsername.value = '';
                elements.signupEmail.value = '';
                elements.signupPassword.value = '';
                elements.loginError.textContent = '';
                elements.signupError.textContent = '';
            }).catch((error) => {
                showToast('Error logging out: ' + error.message);
            });
        }
        
        function loadPlayerData(userId) {
            // Load player data from database
            database.ref('players/' + userId).once('value')
                .then((snapshot) => {
                    const playerData = snapshot.val();
                    
                    // Initialize player
                    gameState.player = {
                        id: userId,
                        username: playerData.username,
                        email: playerData.email,
                        health: playerData.health,
                        coins: playerData.coins,
                        kills: playerData.kills,
                        deaths: playerData.deaths,
                        x: playerData.x,
                        y: playerData.y,
                        lastUpdated: playerData.lastUpdated,
                        weapons: playerData.weapons || { pistol: true },
                        currentWeapon: playerData.currentWeapon || 'pistol',
                        clan: playerData.clan || null
                    };
                    
                    // Update local game state
                    gameState.health = playerData.health;
                    gameState.coins = playerData.coins;
                    gameState.kills = playerData.kills;
                    gameState.currentWeapon = playerData.currentWeapon || 'pistol';
                    
                    // Update UI
                    updatePlayerUI();
                    
                    // Load clan data if in a clan
                    if (gameState.player.clan) {
                        loadClanData(gameState.player.clan);
                    }
                    
                    // Initialize game
                    initGame();
                    
                    // Hide loading and auth screen
                    hideLoading();
                    elements.authScreen.classList.add('hidden');
                    elements.gameScreen.style.display = 'flex';
                })
                .catch((error) => {
                    hideLoading();
                    showToast('Error loading player data: ' + error.message);
                    logout();
                });
        }
        
        function clearGameState() {
            // Stop game loop
            if (gameState.gameLoopInterval) {
                clearInterval(gameState.gameLoopInterval);
                gameState.gameLoopInterval = null;
            }
            
            // Remove Firebase listeners
            if (gameState.playerRef) gameState.playerRef.off();
            if (gameState.playersRef) gameState.playersRef.off();
            if (gameState.bulletsRef) gameState.bulletsRef.off();
            if (gameState.lootRef) gameState.lootRef.off();
            if (gameState.healthPacksRef) gameState.healthPacksRef.off();
            if (gameState.leaderboardRef) gameState.leaderboardRef.off();
            if (gameState.friendsRef) gameState.friendsRef.off();
            if (gameState.friendRequestsRef) gameState.friendRequestsRef.off();
            if (gameState.clanRef) gameState.clanRef.off();
            if (gameState.clanMembersRef) gameState.clanMembersRef.off();
            if (gameState.chatRef) gameState.chatRef.off();
            
            // Clear game state
            gameState.player = null;
            gameState.players = {};
            gameState.bullets = {};
            gameState.loot = {};
            gameState.healthPacks = {};
            gameState.friends = {};
            gameState.friendRequests = {};
            gameState.clan = null;
            gameState.clanMembers = {};
            gameState.chatMessages = [];
        }

        // Game functions
        function initGame() {
            // Initialize canvas
            initCanvas();
            
            // Set up Firebase references
            gameState.playerRef = database.ref('players/' + gameState.player.id);
            gameState.playersRef = database.ref('players');
            gameState.bulletsRef = database.ref('bullets');
            gameState.lootRef = database.ref('loot');
            gameState.healthPacksRef = database.ref('healthPacks');
            gameState.leaderboardRef = database.ref('leaderboard');
            gameState.friendsRef = database.ref('friends/' + gameState.player.id);
            gameState.friendRequestsRef = database.ref('friendRequests/' + gameState.player.id);
            gameState.chatRef = database.ref('chat');
            
            // Set up Firebase listeners
            setupFirebaseListeners();
            
            // Initialize shop
            initShop();
            
            // Initialize weapon selector
            initWeaponSelector();
            
            // Start game loop
            gameState.gameLoopInterval = setInterval(gameLoop, 1000 / 60);
            
            // Spawn initial loot and health packs
            spawnInitialLoot();
            spawnInitialHealthPacks();
            
            // Update player position in database
            updatePlayerPosition();
        }
        
        function setupFirebaseListeners() {
            // Listen for player updates
            gameState.playersRef.on('value', (snapshot) => {
                const players = snapshot.val() || {};
                gameState.players = {};
                
                for (const playerId in players) {
                    if (playerId !== gameState.player.id) {
                        gameState.players[playerId] = players[playerId];
                    }
                }
            });
            
            // Listen for bullet updates
            gameState.bulletsRef.on('value', (snapshot) => {
                gameState.bullets = snapshot.val() || {};
            });
            
            // Listen for loot updates
            gameState.lootRef.on('value', (snapshot) => {
                gameState.loot = snapshot.val() || {};
            });
            
            // Listen for health pack updates
            gameState.healthPacksRef.on('value', (snapshot) => {
                gameState.healthPacks = snapshot.val() || {};
            });
            
            // Listen for leaderboard updates
            gameState.leaderboardRef.on('value', (snapshot) => {
                const leaderboard = snapshot.val() || {};
                updateLeaderboard(leaderboard);
            });
            
            // Listen for friend updates
            gameState.friendsRef.on('value', (snapshot) => {
                gameState.friends = snapshot.val() || {};
                updateFriendsList();
            });
            
            // Listen for friend requests
            gameState.friendRequestsRef.on('value', (snapshot) => {
                gameState.friendRequests = snapshot.val() || {};
                // You could show notifications for new friend requests here
            });
            
            // Listen for chat messages
            gameState.chatRef.limitToLast(20).on('value', (snapshot) => {
                const messages = snapshot.val() || {};
                gameState.chatMessages = Object.values(messages);
                updateChat();
            });
            
            // Update player data in realtime
            gameState.playerRef.onDisconnect().update({
                online: false,
                lastUpdated: Date.now()
            });
            
            // Mark player as online
            gameState.playerRef.update({
                online: true,
                lastUpdated: Date.now()
            });
        }
        
        function spawnInitialLoot() {
            // Check if loot already exists
            gameState.lootRef.once('value').then((snapshot) => {
                if (!snapshot.exists() || Object.keys(snapshot.val()).length < 20) {
                    // Spawn 20 loot items
                    for (let i = 0; i < 20; i++) {
                        const loot = {
                            x: Math.random() * gameState.maps[gameState.currentMap].width,
                            y: Math.random() * gameState.maps[gameState.currentMap].height,
                            value: Math.floor(Math.random() * 50) + 10,
                            collected: false
                        };
                        
                        gameState.lootRef.push(loot);
                    }
                }
            });
        }
        
        function spawnInitialHealthPacks() {
            // Check if health packs already exist
            gameState.healthPacksRef.once('value').then((snapshot) => {
                if (!snapshot.exists() || Object.keys(snapshot.val()).length < 10) {
                    // Spawn 10 health packs
                    for (let i = 0; i < 10; i++) {
                        const healthPack = {
                            x: Math.random() * gameState.maps[gameState.currentMap].width,
                            y: Math.random() * gameState.maps[gameState.currentMap].height,
                            health: 25,
                            collected: false
                        };
                        
                        gameState.healthPacksRef.push(healthPack);
                    }
                }
            });
        }
        
        function gameLoop() {
            // Clear canvas
            ctx.clearRect(0, 0, elements.gameCanvas.width, elements.gameCanvas.height);
            
            // Update player position if alive
            if (gameState.isAlive) {
                updatePlayerPosition();
                
                // Handle shooting
                if (gameState.isShooting) {
                    shoot();
                }
                
                // Check for collisions
                checkCollisions();
            } else {
                // Handle respawn timer
                if (gameState.respawnTime > 0) {
                    gameState.respawnTime -= 1000 / 60;
                    elements.respawnTimer.textContent = `Respawning in ${Math.ceil(gameState.respawnTime / 1000)}...`;
                    
                    if (gameState.respawnTime <= 0) {
                        respawnPlayer();
                    }
                }
            }
            
            // Draw game world
            drawGame();
        }
        
        function updatePlayerPosition() {
            const speed = gameState.keys.shift ? 3 : 5; // Slower when holding shift
            let dx = 0;
            let dy = 0;
            
            if (gameState.keys.w) dy -= speed;
            if (gameState.keys.s) dy += speed;
            if (gameState.keys.a) dx -= speed;
            if (gameState.keys.d) dx += speed;
            
            // Normalize diagonal movement
            if (dx !== 0 && dy !== 0) {
                dx *= 0.7071; // 1/sqrt(2)
                dy *= 0.7071;
            }
            
            // Calculate new position
            let newX = gameState.player.x + dx;
            let newY = gameState.player.y + dy;
            
            // Check boundaries
            newX = Math.max(0, Math.min(gameState.maps[gameState.currentMap].width, newX));
            newY = Math.max(0, Math.min(gameState.maps[gameState.currentMap].height, newY));
            
            // Check obstacle collisions
            for (const obstacle of gameState.maps[gameState.currentMap].obstacles) {
                if (
                    newX > obstacle.x - 20 && 
                    newX < obstacle.x + obstacle.width + 20 &&
                    newY > obstacle.y - 20 && 
                    newY < obstacle.y + obstacle.height + 20
                ) {
                    // Collision detected, don't move
                    newX = gameState.player.x;
                    newY = gameState.player.y;
                    break;
                }
            }
            
            // Update player position
            gameState.player.x = newX;
            gameState.player.y = newY;
            
            // Update in database
            gameState.playerRef.update({
                x: newX,
                y: newY,
                lastUpdated: Date.now(),
                lastAngle: gameState.mouse.angle
            });
        }
        
        function shoot() {
            const now = Date.now();
            const weapon = gameState.weapons[gameState.currentWeapon];
            
            if (now - gameState.lastShot > weapon.fireRate) {
                gameState.lastShot = now;
                
                // Create bullet(s)
                if (weapon.spread) {
                    // Shotgun-style spread
                    for (let i = 0; i < weapon.bullets; i++) {
                        const spreadAngle = gameState.mouse.angle + (Math.random() - 0.5) * weapon.spread;
                        const bullet = {
                            x: gameState.player.x,
                            y: gameState.player.y,
                            angle: spreadAngle,
                            speed: weapon.bulletSpeed,
                            range: weapon.range,
                            damage: weapon.damage,
                            owner: gameState.player.id,
                            timestamp: now
                        };
                        
                        // Add to database
                        gameState.bulletsRef.push(bullet);
                    }
                } else {
                    // Single bullet
                    const bullet = {
                        x: gameState.player.x,
                        y: gameState.player.y,
                        angle: gameState.mouse.angle,
                        speed: weapon.bulletSpeed,
                        range: weapon.range,
                        damage: weapon.damage,
                        owner: gameState.player.id,
                        timestamp: now
                    };
                    
                    // Add to database
                    gameState.bulletsRef.push(bullet);
                }
                
                // Play shoot sound (would be implemented with Audio API)
                // playSound('shoot');
            }
        }
        
        function checkCollisions() {
            // Check bullet collisions
            for (const bulletId in gameState.bullets) {
                const bullet = gameState.bullets[bulletId];
                
                // Skip bullets owned by this player or too old
                if (bullet.owner === gameState.player.id || Date.now() - bullet.timestamp > 5000) {
                    continue;
                }
                
                // Calculate bullet position
                const time = (Date.now() - bullet.timestamp) / 1000;
                const distance = bullet.speed * time;
                const bulletX = bullet.x + Math.cos(bullet.angle) * distance;
                const bulletY = bullet.y + Math.sin(bullet.angle) * distance;
                
                // Check if bullet is in range
                if (distance > bullet.range) {
                    continue;
                }
                
                // Check collision with player
                const dx = bulletX - gameState.player.x;
                const dy = bulletY - gameState.player.y;
                const distanceToPlayer = Math.sqrt(dx * dx + dy * dy);
                
                if (distanceToPlayer < 20) { // Player hit radius
                    // Check if shooter is in the same clan
                    const shooterClan = gameState.players[bullet.owner]?.clan;
                    if (shooterClan && shooterClan === gameState.player.clan) {
                        // Same clan, no damage
                        continue;
                    }
                    
                    // Take damage
                    takeDamage(bullet.damage, bullet.owner);
                    
                    // Remove bullet
                    database.ref('bullets/' + bulletId).remove();
                    
                    break;
                }
            }
            
            // Check loot collisions
            for (const lootId in gameState.loot) {
                const loot = gameState.loot[lootId];
                
                if (loot.collected) continue;
                
                const dx = loot.x - gameState.player.x;
                const dy = loot.y - gameState.player.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 30) { // Loot collection radius
                    collectLoot(lootId, loot.value);
                    break;
                }
            }
            
            // Check health pack collisions
            for (const packId in gameState.healthPacks) {
                const pack = gameState.healthPacks[packId];
                
                if (pack.collected) continue;
                
                const dx = pack.x - gameState.player.x;
                const dy = pack.y - gameState.player.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 30) { // Health pack collection radius
                    collectHealthPack(packId, pack.health);
                    break;
                }
            }
        }
        
        function takeDamage(amount, attackerId) {
            if (!gameState.isAlive) return;
            
            gameState.health -= amount;
            updatePlayerUI();
            
            // Update in database
            gameState.playerRef.update({
                health: gameState.health
            });
            
            if (gameState.health <= 0) {
                // Player died
                gameState.isAlive = false;
                gameState.deaths++;
                gameState.respawnTime = 3000; // 3 seconds
                
                // Show respawn screen
                elements.respawnScreen.style.display = 'flex';
                
                // Update in database
                gameState.playerRef.update({
                    health: 0,
                    deaths: gameState.deaths
                });
                
                // Give kill to attacker
                if (attackerId && attackerId !== gameState.player.id) {
                    database.ref('players/' + attackerId + '/kills').transaction((kills) => {
                        return (kills || 0) + 1;
                    });
                    
                    // Update leaderboard
                    database.ref('leaderboard/' + attackerId).transaction((data) => {
                        if (!data) {
                            return { kills: 1, coins: 0 };
                        }
                        return { ...data, kills: (data.kills || 0) + 1 };
                    });
                }
                
                showToast('You were killed! Respawning in 3 seconds...');
            }
        }
        
        function collectLoot(lootId, value) {
            gameState.coins += value;
            gameState.player.coins = gameState.coins;
            
            // Update UI
            updatePlayerUI();
            
            // Update in database
            gameState.playerRef.update({
                coins: gameState.coins
            });
            
            // Mark loot as collected
            database.ref('loot/' + lootId).update({
                collected: true
            });
            
            // Remove loot after a delay
            setTimeout(() => {
                database.ref('loot/' + lootId).remove();
                
                // Spawn new loot
                const newLoot = {
                    x: Math.random() * gameState.maps[gameState.currentMap].width,
                    y: Math.random() * gameState.maps[gameState.currentMap].height,
                    value: Math.floor(Math.random() * 50) + 10,
                    collected: false
                };
                
                gameState.lootRef.push(newLoot);
            }, 1000);
            
            // Update leaderboard
            database.ref('leaderboard/' + gameState.player.id).transaction((data) => {
                if (!data) {
                    return { kills: 0, coins: value };
                }
                return { ...data, coins: (data.coins || 0) + value };
            });
            
            showToast(`Collected ${value} coins!`);
        }
        
        function collectHealthPack(packId, health) {
            const newHealth = Math.min(100, gameState.health + health);
            const healthGained = newHealth - gameState.health;
            gameState.health = newHealth;
            
            // Update UI
            updatePlayerUI();
            
            // Update in database
            gameState.playerRef.update({
                health: gameState.health
            });
            
            // Mark health pack as collected
            database.ref('healthPacks/' + packId).update({
                collected: true
            });
            
            // Remove health pack after a delay
            setTimeout(() => {
                database.ref('healthPacks/' + packId).remove();
                
                // Spawn new health pack
                const newPack = {
                    x: Math.random() * gameState.maps[gameState.currentMap].width,
                    y: Math.random() * gameState.maps[gameState.currentMap].height,
                    health: 25,
                    collected: false
                };
                
                gameState.healthPacksRef.push(newPack);
            }, 1000);
            
            showToast(`Collected health pack! +${healthGained} HP`);
        }
        
        function respawnPlayer() {
            gameState.health = 100;
            gameState.isAlive = true;
            gameState.respawnTime = 0;
            
            // Update in database
            gameState.playerRef.update({
                health: gameState.health,
                x: Math.random() * gameState.maps[gameState.currentMap].width,
                y: Math.random() * gameState.maps[gameState.currentMap].height
            });
            
            // Update UI
            updatePlayerUI();
            
            // Hide respawn screen
            elements.respawnScreen.style.display = 'none';
            
            showToast('You have respawned!');
        }
        
        function drawGame() {
            const map = gameState.maps[gameState.currentMap];
            
            // Calculate camera offset to center on player
            const cameraX = gameState.player.x - elements.gameCanvas.width / 2;
            const cameraY = gameState.player.y - elements.gameCanvas.height / 2;
            
            // Draw map background
            ctx.fillStyle = map.color;
            ctx.fillRect(-cameraX, -cameraY, map.width, map.height);
            
            // Draw obstacles
            ctx.fillStyle = '#1a1a2e';
            for (const obstacle of map.obstacles) {
                ctx.fillRect(obstacle.x - cameraX, obstacle.y - cameraY, obstacle.width, obstacle.height);
            }
            
            // Draw loot
            ctx.fillStyle = '#f9ca24';
            for (const lootId in gameState.loot) {
                const loot = gameState.loot[lootId];
                if (!loot.collected) {
                    ctx.beginPath();
                    ctx.arc(loot.x - cameraX, loot.y - cameraY, 10, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Draw value
                    ctx.fillStyle = '#ffffff';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(loot.value, loot.x - cameraX, loot.y - cameraY + 3);
                    ctx.fillStyle = '#f9ca24';
                }
            }
            
            // Draw health packs
            ctx.fillStyle = '#2ecc71';
            for (const packId in gameState.healthPacks) {
                const pack = gameState.healthPacks[packId];
                if (!pack.collected) {
                    ctx.beginPath();
                    ctx.moveTo(pack.x - cameraX, pack.y - cameraY - 10);
                    ctx.lineTo(pack.x - cameraX + 10, pack.y - cameraY + 10);
                    ctx.lineTo(pack.x - cameraX - 10, pack.y - cameraY + 10);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Draw health value
                    ctx.fillStyle = '#ffffff';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(pack.health, pack.x - cameraX, pack.y - cameraY + 20);
                    ctx.fillStyle = '#2ecc71';
                }
            }
            
            // Draw bullets
            ctx.fillStyle = '#f1c40f';
            for (const bulletId in gameState.bullets) {
                const bullet = gameState.bullets[bulletId];
                
                // Skip old bullets
                if (Date.now() - bullet.timestamp > 5000) {
                    continue;
                }
                
                // Calculate bullet position
                const time = (Date.now() - bullet.timestamp) / 1000;
                const distance = bullet.speed * time;
                const bulletX = bullet.x + Math.cos(bullet.angle) * distance;
                const bulletY = bullet.y + Math.sin(bullet.angle) * distance;
                
                // Skip bullets out of range
                if (distance > bullet.range) {
                    continue;
                }
                
                // Draw bullet
                ctx.save();
                ctx.translate(bulletX - cameraX, bulletY - cameraY);
                ctx.rotate(bullet.angle);
                ctx.fillRect(-5, -2, 10, 4);
                ctx.restore();
            }
            
            // Draw other players
            for (const playerId in gameState.players) {
                const player = gameState.players[playerId];
                
                // Skip offline players
                if (!player.online) continue;
                
                // Calculate direction angle
                const angle = player.lastAngle || 0;
                
                // Draw player
                ctx.save();
                ctx.translate(player.x - cameraX, player.y - cameraY);
                ctx.rotate(angle);
                
                // Player body - different color for friends and clan members
                let playerColor = '#e74c3c'; // Default enemy color
                
                if (playerId in gameState.friends) {
                    playerColor = '#3498db'; // Friend color
                }
                
                if (gameState.clan && player.clan === gameState.clan.id) {
                    playerColor = '#2ecc71'; // Clan member color
                }
                
                ctx.fillStyle = playerColor;
                ctx.beginPath();
                ctx.arc(0, 0, 15, 0, Math.PI * 2);
                ctx.fill();
                
                // Player gun
                ctx.fillStyle = '#7f8c8d';
                ctx.fillRect(15, -5, 20, 10);
                
                // Player health bar
                const healthPercent = player.health / 100;
                ctx.fillStyle = healthPercent > 0.6 ? '#2ecc71' : healthPercent > 0.3 ? '#f39c12' : '#e74c3c';
                ctx.fillRect(-15, -25, 30 * healthPercent, 5);
                
                ctx.restore();
                
                // Player name
                ctx.fillStyle = '#ffffff';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(player.username, player.x - cameraX, player.y - cameraY - 30);
            }
            
            // Draw current player if alive
            if (gameState.isAlive) {
                ctx.save();
                ctx.translate(elements.gameCanvas.width / 2, elements.gameCanvas.height / 2);
                ctx.rotate(gameState.mouse.angle);
                
                // Player body
                ctx.fillStyle = '#e94560';
                ctx.beginPath();
                ctx.arc(0, 0, 15, 0, Math.PI * 2);
                ctx.fill();
                
                // Player gun
                ctx.fillStyle = '#7f8c8d';
                ctx.fillRect(15, -5, 20, 10);
                
                // Player health bar
                const healthPercent = gameState.health / 100;
                ctx.fillStyle = healthPercent > 0.6 ? '#2ecc71' : healthPercent > 0.3 ? '#f39c12' : '#e74c3c';
                ctx.fillRect(-15, -25, 30 * healthPercent, 5);
                
                ctx.restore();
            }
            
            // Draw minimap
            drawMinimap(cameraX, cameraY);
        }
        
        function drawMinimap(cameraX, cameraY) {
            const map = gameState.maps[gameState.currentMap];
            const minimapSize = 150;
            const minimapMargin = 10;
            const minimapX = elements.gameCanvas.width - minimapSize - minimapMargin;
            const minimapY = minimapMargin;
            const scale = minimapSize / map.width;
            
            // Minimap background
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(minimapX, minimapY, minimapSize, minimapSize);
            
            // Draw map boundaries
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 1;
            ctx.strokeRect(minimapX, minimapY, minimapSize, minimapSize);
            
            // Draw obstacles
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            for (const obstacle of map.obstacles) {
                ctx.fillRect(
                    minimapX + obstacle.x * scale,
                    minimapY + obstacle.y * scale,
                    obstacle.width * scale,
                    obstacle.height * scale
                );
            }
            
            // Draw loot
            ctx.fillStyle = '#f9ca24';
            for (const lootId in gameState.loot) {
                const loot = gameState.loot[lootId];
                if (!loot.collected) {
                    ctx.beginPath();
                    ctx.arc(
                        minimapX + loot.x * scale,
                        minimapY + loot.y * scale,
                        2,
                        0,
                        Math.PI * 2
                    );
                    ctx.fill();
                }
            }
            
            // Draw health packs
            ctx.fillStyle = '#2ecc71';
            for (const packId in gameState.healthPacks) {
                const pack = gameState.healthPacks[packId];
                if (!pack.collected) {
                    ctx.beginPath();
                    ctx.arc(
                        minimapX + pack.x * scale,
                        minimapY + pack.y * scale,
                        2,
                        0,
                        Math.PI * 2
                    );
                    ctx.fill();
                }
            }
            
            // Draw other players
            for (const playerId in gameState.players) {
                const player = gameState.players[playerId];
                if (!player.online) continue;
                
                // Different color for friends and clan members
                let playerColor = '#e74c3c'; // Default enemy color
                
                if (playerId in gameState.friends) {
                    playerColor = '#3498db'; // Friend color
                }
                
                if (gameState.clan && player.clan === gameState.clan.id) {
                    playerColor = '#2ecc71'; // Clan member color
                }
                
                ctx.fillStyle = playerColor;
                ctx.beginPath();
                ctx.arc(
                    minimapX + player.x * scale,
                    minimapY + player.y * scale,
                    3,
                    0,
                    Math.PI * 2
                );
                ctx.fill();
            }
            
            // Draw current player
            ctx.fillStyle = '#e94560';
            ctx.beginPath();
            ctx.arc(
                minimapX + gameState.player.x * scale,
                minimapY + gameState.player.y * scale,
                3,
                0,
                Math.PI * 2
            );
            ctx.fill();
            
            // Draw viewport rectangle
            ctx.strokeStyle = '#e94560';
            ctx.lineWidth = 1;
            ctx.strokeRect(
                minimapX + cameraX * scale,
                minimapY + cameraY * scale,
                elements.gameCanvas.width * scale,
                elements.gameCanvas.height * scale
            );
        }

        // UI functions
        function updatePlayerUI() {
            elements.healthValue.textContent = gameState.health;
            elements.coinValue.textContent = gameState.coins;
            elements.killsValue.textContent = gameState.kills;
        }
        
        function toggleMenu() {
            if (elements.gameMenu.style.display === 'flex') {
                elements.gameMenu.style.display = 'none';
            } else {
                elements.gameMenu.style.display = 'flex';
                // Refresh leaderboard when opening menu
                database.ref('leaderboard').once('value').then((snapshot) => {
                    updateLeaderboard(snapshot.val() || {});
                });
                // Refresh friends list
                database.ref('friends/' + gameState.player.id).once('value').then((snapshot) => {
                    gameState.friends = snapshot.val() || {};
                    updateFriendsList();
                });
            }
        }
        
        function switchTab(tabId) {
            // Update active tab
            elements.menuTabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Update active content
            elements.menuContents.forEach(content => {
                if (content.id === tabId + '-tab') {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }
        
        function updateLeaderboard(leaderboard) {
            // Convert leaderboard to array
            const leaderboardArray = [];
            
            for (const playerId in leaderboard) {
                leaderboardArray.push({
                    id: playerId,
                    kills: leaderboard[playerId].kills || 0,
                    coins: leaderboard[playerId].coins || 0,
                    username: gameState.players[playerId]?.username || 'Unknown'
                });
            }
            
            // Sort by kills then coins
            leaderboardArray.sort((a, b) => {
                if (b.kills !== a.kills) return b.kills - a.kills;
                return b.coins - a.coins;
            });
            
            // Update UI
            elements.leaderboardList.innerHTML = '';
            
            leaderboardArray.forEach((player, index) => {
                const li = document.createElement('li');
                li.className = 'leaderboard-item';
                
                li.innerHTML = `
                    <div class="leaderboard-rank">${index + 1}</div>
                    <div class="leaderboard-name">${player.username}</div>
                    <div class="leaderboard-stats">
                        <span>🔫 ${player.kills}</span>
                        <span>💰 ${player.coins}</span>
                    </div>
                `;
                
                // Highlight current player
                if (player.id === gameState.player.id) {
                    li.style.backgroundColor = 'rgba(233, 69, 96, 0.3)';
                }
                
                elements.leaderboardList.appendChild(li);
            });
        }
        
        function initShop() {
            // Clear existing items
            elements.shopItems.innerHTML = '';
            
            // Add items for each weapon
            for (const weaponId in gameState.weapons) {
                const weapon = gameState.weapons[weaponId];
                const owned = gameState.player.weapons[weaponId] || false;
                
                const item = document.createElement('div');
                item.className = 'shop-item';
                item.setAttribute('data-weapon', weaponId);
                
                item.innerHTML = `
                    <div class="shop-item-icon">${weapon.icon}</div>
                    <div class="shop-item-name">${weaponId.charAt(0).toUpperCase() + weaponId.slice(1)}</div>
                    <div class="shop-item-price">💰 ${weapon.price}</div>
                    ${owned ? '<div class="shop-item-owned">OWNED</div>' : ''}
                    <div class="shop-item-stats">
                        Damage: ${weapon.damage}<br>
                        Fire Rate: ${Math.round(1000 / weapon.fireRate * 10) / 10}/s<br>
                        Range: ${weapon.range}<br>
                        Speed: ${weapon.bulletSpeed}
                    </div>
                `;
                
                // Highlight equipped weapon
                if (weaponId === gameState.currentWeapon) {
                    item.style.backgroundColor = 'rgba(233, 69, 96, 0.3)';
                }
                
                elements.shopItems.appendChild(item);
            }
        }
        
        function initWeaponSelector() {
            // Clear existing slots
            elements.weaponSelector.innerHTML = '';
            
            // Add slots for each owned weapon
            for (const weaponId in gameState.player.weapons) {
                if (gameState.player.weapons[weaponId]) {
                    const weapon = gameState.weapons[weaponId];
                    const slot = document.createElement('div');
                    slot.className = 'weapon-slot';
                    if (weaponId === gameState.currentWeapon) {
                        slot.classList.add('active');
                    }
                    slot.setAttribute('data-weapon', weaponId);
                    slot.textContent = weapon.icon;
                    elements.weaponSelector.appendChild(slot);
                }
            }
        }
        
        function switchWeapon(weaponId) {
            if (gameState.player.weapons[weaponId]) {
                gameState.currentWeapon = weaponId;
                gameState.player.currentWeapon = weaponId;
                
                // Update in database
                gameState.playerRef.update({
                    currentWeapon: weaponId
                });
                
                // Update weapon selector UI
                document.querySelectorAll('.weapon-slot').forEach(slot => {
                    if (slot.getAttribute('data-weapon') === weaponId) {
                        slot.classList.add('active');
                    } else {
                        slot.classList.remove('active');
                    }
                });
                
                // Update shop UI
                initShop();
            }
        }
        
        function buyWeapon(weaponId) {
            const weapon = gameState.weapons[weaponId];
            
            // Check if already owned
            if (gameState.player.weapons[weaponId]) {
                // Equip the weapon
                switchWeapon(weaponId);
                return;
            }
            
            // Check if player has enough coins
            if (gameState.coins >= weapon.price) {
                // Deduct coins
                gameState.coins -= weapon.price;
                gameState.player.coins = gameState.coins;
                
                // Add weapon to player
                gameState.player.weapons[weaponId] = true;
                gameState.currentWeapon = weaponId;
                gameState.player.currentWeapon = weaponId;
                
                // Update in database
                gameState.playerRef.update({
                    coins: gameState.coins,
                    weapons: gameState.player.weapons,
                    currentWeapon: weaponId
                });
                
                // Update UI
                updatePlayerUI();
                initShop();
                initWeaponSelector();
                showToast(`Purchased ${weaponId} for ${weapon.price} coins!`);
            } else {
                showToast(`Not enough coins! Need ${weapon.price - gameState.coins} more.`);
            }
        }
        
        function updateFriendsList() {
            elements.friendsList.innerHTML = '';
            
            for (const friendId in gameState.friends) {
                const friend = gameState.players[friendId] || { username: 'Unknown', online: false };
                
                const li = document.createElement('li');
                li.className = 'friend-item';
                
                li.innerHTML = `
                    <div class="friend-status ${friend.online ? 'online' : 'offline'}"></div>
                    <div class="friend-name">${friend.username || 'Unknown'}</div>
                    <div class="friend-actions">
                        <button class="friend-action" data-action="invite" data-friend-id="${friendId}">Invite</button>
                        <button class="friend-action" data-action="remove" data-friend-id="${friendId}">Remove</button>
                    </div>
                `;
                
                elements.friendsList.appendChild(li);
            }
            
            // Add event listeners for friend actions
            document.querySelectorAll('[data-action="invite"]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const friendId = e.target.getAttribute('data-friend-id');
                    inviteFriend(friendId);
                });
            });
            
            document.querySelectorAll('[data-action="remove"]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const friendId = e.target.getAttribute('data-friend-id');
                    removeFriend(friendId);
                });
            });
        }
        
        function sendFriendRequest() {
            const email = elements.friendEmail.value.trim();
            
            if (!email) {
                showToast('Please enter an email');
                return;
            }
            
            // Find user by email
            database.ref('players').orderByChild('email').equalTo(email).once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        showToast('No player found with that email');
                        return;
                    }
                    
                    const friendId = Object.keys(snapshot.val())[0];
                    const friendData = snapshot.val()[friendId];
                    
                    // Check if already friends
                    if (friendId in gameState.friends) {
                        showToast(`You're already friends with ${friendData.username}`);
                        return;
                    }
                    
                    // Check if already sent request
                    database.ref('friendRequests/' + friendId + '/' + gameState.player.id).once('value')
                        .then((requestSnapshot) => {
                            if (requestSnapshot.exists()) {
                                showToast('Friend request already sent');
                                return;
                            }
                            
                            // Send friend request
                            database.ref('friendRequests/' + friendId + '/' + gameState.player.id).set({
                                username: gameState.player.username,
                                email: gameState.player.email
                            }).then(() => {
                                showToast(`Friend request sent to ${friendData.username}`);
                                elements.friendEmail.value = '';
                            });
                        });
                })
                .catch((error) => {
                    showToast('Error sending friend request: ' + error.message);
                });
        }
        
        function inviteFriend(friendId) {
            const friend = gameState.players[friendId];
            if (!friend || !friend.online) {
                showToast('Friend is offline');
                return;
            }
            
            // Create a private game code if we don't have one
            if (!gameState.gameCode) {
                gameState.gameCode = generateGameCode();
                showToast(`Created private game with code: ${gameState.gameCode}`);
            }
            
            // Send invite
            database.ref('friendRequests/' + friendId + '/' + gameState.player.id).set({
                username: gameState.player.username,
                email: gameState.player.email,
                gameCode: gameState.gameCode,
                type: 'game_invite'
            }).then(() => {
                showToast(`Invitation sent to ${friend.username}`);
            });
        }
        
        function removeFriend(friendId) {
            // Remove from friends list
            database.ref('friends/' + gameState.player.id + '/' + friendId).remove()
                .then(() => {
                    showToast('Friend removed');
                })
                .catch((error) => {
                    showToast('Error removing friend: ' + error.message);
                });
        }
        
        function loadClanData(clanId) {
            gameState.clanRef = database.ref('clans/' + clanId);
            gameState.clanMembersRef = database.ref('clanMembers/' + clanId);
            
            // Load clan info
            gameState.clanRef.once('value').then((snapshot) => {
                const clanData = snapshot.val();
                if (clanData) {
                    gameState.clan = {
                        id: clanId,
                        name: clanData.name,
                        code: clanData.code,
                        leader: clanData.leader
                    };
                    
                    // Update UI
                    elements.clanInfo.style.display = 'block';
                    elements.noClanMessage.style.display = 'none';
                    elements.clanName.textContent = clanData.name;
                    
                    // Show clan members count
                    gameState.clanMembersRef.once('value').then((membersSnapshot) => {
                        const members = membersSnapshot.val() || {};
                        elements.clanMembersCount.textContent = `Members: ${Object.keys(members).length}`;
                    });
                    
                    // Load clan members
                    gameState.clanMembersRef.on('value', (membersSnapshot) => {
                        const members = membersSnapshot.val() || {};
                        gameState.clanMembers = members;
                        
                        // Update UI
                        elements.clanMembersList.innerHTML = '';
                        
                        for (const memberId in members) {
                            const member = members[memberId];
                            const li = document.createElement('li');
                            li.className = 'clan-member';
                            
                            li.innerHTML = `
                                <div>${member.username}</div>
                                <div>${memberId === gameState.clan.leader ? '👑' : ''}</div>
                            `;
                            
                            elements.clanMembersList.appendChild(li);
                        }
                    });
                } else {
                    // Clan doesn't exist, leave it
                    leaveClan();
                }
            });
        }
        
        function joinClan() {
            const code = elements.joinClanInput.value.trim();
            
            if (!code) {
                showToast('Please enter a clan code');
                return;
            }
            
            // Find clan by code
            database.ref('clans').orderByChild('code').equalTo(code).once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        showToast('No clan found with that code');
                        return;
                    }
                    
                    const clanId = Object.keys(snapshot.val())[0];
                    const clanData = snapshot.val()[clanId];
                    
                    // Join clan
                    database.ref('clanMembers/' + clanId + '/' + gameState.player.id).set({
                        username: gameState.player.username
                    }).then(() => {
                        // Update player clan
                        gameState.player.clan = clanId;
                        gameState.playerRef.update({
                            clan: clanId
                        });
                        
                        // Load clan data
                        loadClanData(clanId);
                        
                        showToast(`Joined clan ${clanData.name}!`);
                        elements.joinClanInput.value = '';
                    });
                })
                .catch((error) => {
                    showToast('Error joining clan: ' + error.message);
                });
        }
        
        function createClan() {
            const name = elements.createClanInput.value.trim();
            
            if (!name) {
                showToast('Please enter a clan name');
                return;
            }
            
            if (name.length < 3 || name.length > 20) {
                showToast('Clan name must be 3-20 characters');
                return;
            }
            
            // Generate clan code
            const code = generateClanCode();
            
            // Create clan
            const clanId = database.ref('clans').push().key;
            
            const clanData = {
                name: name,
                code: code,
                leader: gameState.player.id,
                createdAt: Date.now()
            };
            
            database.ref('clans/' + clanId).set(clanData)
                .then(() => {
                    // Add player as member
                    return database.ref('clanMembers/' + clanId + '/' + gameState.player.id).set({
                        username: gameState.player.username
                    });
                })
                .then(() => {
                    // Update player clan
                    gameState.player.clan = clanId;
                    return gameState.playerRef.update({
                        clan: clanId
                    });
                })
                .then(() => {
                    // Load clan data
                    loadClanData(clanId);
                    
                    showToast(`Created clan ${name}! Code: ${code}`);
                    elements.createClanInput.value = '';
                })
                .catch((error) => {
                    showToast('Error creating clan: ' + error.message);
                });
        }
        
        function leaveClan() {
            if (!gameState.clan) return;
            
            // Remove player from clan members
            database.ref('clanMembers/' + gameState.clan.id + '/' + gameState.player.id).remove()
                .then(() => {
                    // If player was the leader and last member, delete the clan
                    if (gameState.clan.leader === gameState.player.id) {
                        return database.ref('clanMembers/' + gameState.clan.id).once('value')
                            .then((snapshot) => {
                                if (!snapshot.exists() || Object.keys(snapshot.val()).length === 0) {
                                    return database.ref('clans/' + gameState.clan.id).remove();
                                } else {
                                    // Assign new leader
                                    const members = snapshot.val();
                                    const newLeader = Object.keys(members)[0];
                                    return database.ref('clans/' + gameState.clan.id).update({
                                        leader: newLeader
                                    });
                                }
                            });
                    }
                })
                .then(() => {
                    // Update player clan
                    gameState.player.clan = null;
                    return gameState.playerRef.update({
                        clan: null
                    });
                })
                .then(() => {
                    // Clear clan data
                    gameState.clan = null;
                    gameState.clanMembers = {};
                    
                    // Update UI
                    elements.clanInfo.style.display = 'none';
                    elements.noClanMessage.style.display = 'block';
                    
                    showToast('Left clan');
                })
                .catch((error) => {
                    showToast('Error leaving clan: ' + error.message);
                });
        }
        
        function selectGameMode(modeId) {
            gameState.gameMode = modeId;
            
            if (modeId === 'join') {
                elements.joinGameForm.style.display = 'flex';
            } else {
                elements.joinGameForm.style.display = 'none';
                
                if (modeId === 'private') {
                    gameState.gameCode = generateGameCode();
                    showToast(`Created private game with code: ${gameState.gameCode}`);
                } else {
                    gameState.gameCode = null;
                    showToast('Joined public game');
                }
            }
        }
        
        function joinPrivateGame() {
            const code = elements.gameCodeInput.value.trim();
            
            if (!code) {
                showToast('Please enter a game code');
                return;
            }
            
            // In a real implementation, we'd verify the game code exists
            gameState.gameCode = code;
            showToast(`Joined game with code: ${code}`);
            elements.gameCodeInput.value = '';
        }
        
        function toggleChat() {
            if (elements.chatMessages.style.display === 'none') {
                elements.chatMessages.style.display = 'flex';
                elements.chatInputContainer.style.display = 'flex';
                elements.chatToggle.textContent = '−';
            } else {
                elements.chatMessages.style.display = 'none';
                elements.chatInputContainer.style.display = 'none';
                elements.chatToggle.textContent = '+';
            }
        }
        
        function sendChatMessage() {
            const message = elements.chatInput.value.trim();
            
            if (!message) return;
            
            // Add message to chat
            database.ref('chat').push({
                sender: gameState.player.username,
                message: message,
                timestamp: Date.now()
            }).then(() => {
                elements.chatInput.value = '';
            }).catch((error) => {
                showToast('Error sending message: ' + error.message);
            });
        }
        
        function updateChat() {
            elements.chatMessages.innerHTML = '';
            
            // Sort messages by timestamp
            gameState.chatMessages.sort((a, b) => a.timestamp - b.timestamp);
            
            // Display messages
            gameState.chatMessages.forEach(msg => {
                const div = document.createElement('div');
                div.className = 'chat-message';
                div.innerHTML = `<span class="sender">${msg.sender}:</span> ${msg.message}`;
                elements.chatMessages.appendChild(div);
            });
            
            // Scroll to bottom
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
        }

        // Utility functions
        function showError(element, message) {
            element.textContent = message;
            setTimeout(() => {
                element.textContent = '';
            }, 3000);
        }
        
        function showToast(message) {
            elements.toast.textContent = message;
            elements.toast.classList.add('show');
            
            setTimeout(() => {
                elements.toast.classList.remove('show');
            }, 3000);
        }
        
        function showLoading() {
            elements.loadingScreen.style.display = 'flex';
        }
        
        function hideLoading() {
            elements.loadingScreen.style.display = 'none';
        }
        
        function generateClanCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        function generateGameCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // Initialize the app
        initCanvas();
        setupEventListeners();
        
        // Check auth state
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in
                loadPlayerData(user.uid);
            } else {
                // User is signed out
                hideLoading();
                elements.authScreen.classList.remove('hidden');
                elements.gameScreen.style.display = 'none';
            }
        });
    </script>
</body>
</html>
